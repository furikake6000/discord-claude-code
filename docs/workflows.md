# メインワークフロー

## on_messageワークフロー

```mermaid
graph TD;
  A(メッセージを受信) --> AA{メッセージのprefixは/か？};
  AA -->|yes| AB(コマンドとして処理（別ワークフロー）);
  AA -->|no| E{チャンネル名はrepo_で始まるか？};
  E -->|yes| G[チャンネル名からリポジトリ名を抽出];
  E -->|no| F[処理対象のメッセージではないため終了];
  G --> B{メッセージはスレッド内か？};
  B -->|yes| C{自分がメンションされているか？};
  B -->|no| D{対象スレッドに対応するworktreeが存在するか？};
  C -->|no| F;
  C -->|yes| I{workspace/repos/の中に対象のリポジトリが存在するか？};
  I -->|no| K[cloneコマンドでのリポジトリクローンを促すエラーメッセージを出力して終了];
  I -->|yes| J[workspace/trees/の下にworktreeを作成];
  J --> M[worktreeをワークスペースとしてClaude Codeを実行];
  M --> N[APIコールを行いレスポンスを取得];
  N --> O{レスポンスの種類は？};
  O -->|Message| P[Discordに出力];
  O -->|ToolUse| Q[ツールの実行内容をDiscordに出力];
  O -->|Thinking| R[Discordに出力];
  P --> S{レスポンスは完了したか？};
  Q --> S;
  R --> S;
  S -->|yes| T[「回答完了」メッセージを出力して終了];
  S -->|no| O;
  D -->|yes| U{メモリ内にClaude Code Session IDは保存されているか？};
  D -->|no| V[workspace/trees/の下にworktreeを作成];
  V --> U;
  U -->|yes| W[Claude CodeリクエストパラメータにSession IDを追加];
  U -->|no| X[そのスレッドの過去の会話内容を取得しリクエストメッセージに追加];
  W --> M;
  X --> M;
```

### 補足

- Jのworktreeは、リポジトリのmainブランチから作成される。worktreeの名前は `workspace/trees/<チャンネルID>/<スレッドID>` となる。
- Qのツール出力は、1回のメッセージ処理につき最新3件のもののみ表示。
- P, Q, Rの出力は、投稿がチャンネルかスレッド内かによって適切な場所に行われる。
- Xの過去の会話内容は最大30件、最大1000文字のいずれかの制限を超えないように取得される。いずれも超えない場合、会話全文が取得される。

# commandワークフロー

## switchコマンドワークフロー

スレッド内でのみ実行可能なコマンドです。指定されたbranchに切り替えます。`-c`オプションを指定すると、新しいブランチの作成を行います。
`-c`オプション指定時のみブランチ名を省略できます。省略した場合、Claude Codeに過去のスレッドの内容を元にブランチ名を決定させます。

Usage: `/switch [-c] <branch_name?>`

```mermaid
graph TD;
  A(コマンドを実行) --> B{メッセージはスレッド内か？};
  B -->|yes| C{チャンネル名はrepo_で始まるか？};
  B -->|no| D[実行対象外のため、エラーメッセージを出力し終了];
  C -->|yes| E[チャンネル名からリポジトリ名を抽出];
  C -->|no| D;
  E --> G{workspace/repos/の中に対象のリポジトリが存在するか？};
  G -->|no| H[cloneコマンドでのリポジトリクローンを促すエラーメッセージを出力して終了];
  G -->|yes| I[workspace/trees/の下にworktreeを作成];
  I --> J{メッセージに-cオプションが指定されているか？};
  J -->|yes| K{ブランチ名を省略しているか？};
  J -->|no| L{指定されたブランチは存在しているか？};
  L -->|yes| M[指定されたブランチに切り替えるコマンドを実行];
  L -->|no| N[ブランチが存在しない旨のエラーメッセージを出力して終了];
  K -->|yes| O[そのスレッドの過去の会話内容を取得しリクエストメッセージに追加];
  O --> P[Claude Codeにブランチ名を決定させる];
  P --> Q{指定されたブランチはすでに存在しているか？};
  Q -->|yes| R[指定されたブランチはすでに存在している旨のエラーメッセージを出力して終了];
  Q -->|no| S[指定されたブランチ名でブランチを作成して切り替えるコマンドを実行];
```

### 補足

- Oの過去の会話内容は最大30件、最大1000文字のいずれかの制限を超えないように取得される。いずれも超えない場合、会話全文が取得される。

## cloneコマンドワークフロー

指定されたリポジトリをクローンします。
第二引数は省略可能で、指定しない場合はリポジトリ名と同じ名前のディレクトリにクローンされます。

Usage: `/clone <repository_url> <directory?>`

```mermaid
graph TD;
  A(コマンドを実行) --> B{workspace/repos/の中に作成予定のディレクトリが存在するか？};
  B -->|yes| C[ディレクトリが存在する旨のエラーメッセージを出力して終了];
  B -->|no| D[指定されたリポジトリをクローン];
```

## quitコマンドワークフロー

スレッド内でのみ実行可能なコマンドです。現在のスレッドに対応するworktreeを削除します。
Usage: `/quit`

```mermaid
graph TD;
  A(コマンドを実行) --> B{メッセージはスレッド内か？};
  B -->|yes| C{チャンネル名はrepo_で始まるか？};
  B -->|no| D[実行対象外のため、エラーメッセージを出力し終了];
  C -->|yes| E[チャンネル名からリポジトリ名を抽出];
  C -->|no| D;
  E --> F{workspace/trees/の中に対象のworktreeが存在するか？};
  F -->|yes| G[対象のworktreeを削除];
  F -->|no| H[worktreeが既に存在しない旨のメッセージを出力して終了];
```
